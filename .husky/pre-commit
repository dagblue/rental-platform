#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run ESLint only on staged TypeScript files
echo "Running ESLint on staged TypeScript files..."

# Get staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$')

if [ -n "$STAGED_TS_FILES" ]; then
  # Run ESLint only on actual source files (exclude generated files)
  FILTERED_FILES=""
  for file in $STAGED_TS_FILES; do
    if [[ ! "$file" =~ (node_modules|dist|client/|runtime/|generated/) ]] && [ -f "$file" ]; then
      FILTERED_FILES="$FILTERED_FILES $file"
    fi
  done
  
  if [ -n "$FILTERED_FILES" ]; then
    echo "Checking: $FILTERED_FILES"
    npx eslint $FILTERED_FILES --max-warnings=10
    
    if [ $? -ne 0 ]; then
      echo "ESLint failed. Fix errors or use --no-verify to skip."
      exit 1
    fi
  else
    echo "No source TypeScript files to lint."
  fi
else
  echo "No staged TypeScript files to lint."
fi

# Run prettier if needed
echo "Checking formatting..."
npx lint-staged
